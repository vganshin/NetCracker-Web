const authApi = {};

authApi.getProfile = () => new Promise((resolve, reject) => {
  const xmlhttp = new XMLHttpRequest();

  xmlhttp.open('GET', '/api/auth/profile', true);

  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState === 4) {
      if (xmlhttp.status === 200) {
        const response = JSON.parse(xmlhttp.responseText)
        return response.status === "OK" ? resolve(response.message) : reject("Not Auth");
      } else {
        return reject("Not Auth");
      }
    }
  };

  xmlhttp.send();
});

authApi.login = credentials => new Promise((resolve, reject) => {
  const email = credentials.email;
  const password = credentials.password;
  const xmlhttp = new XMLHttpRequest();

  xmlhttp.open('POST', '/api/auth/login', true);
  xmlhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState === 4) {
      authApi.getProfile()
        .then(profile => resolve(profile))
        .catch(error => reject(error));
      }
  };

  xmlhttp.send(`email=${email}&password=${password}&remember=on`);
});

authApi.register = credentials => new Promise((resolve, reject) => {
  const xmlhttp = new XMLHttpRequest();

  xmlhttp.open('POST', '/api/auth/register', true);
  xmlhttp.setRequestHeader('Content-Type', 'application/json');

  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState === 4) {
      if (xmlhttp.status === 200) {
        const json = JSON.parse(xmlhttp.responseText)
        if (json.status === "OK") {
          resolve(json.message);
        } else {
          reject(json.message);
        }
      } else {
        return reject("Something went wrong");
      }
    }
  };

  xmlhttp.send(JSON.stringify(credentials));
});

authApi.logout = () => new Promise((resolve, reject) => {
  const xmlhttp = new XMLHttpRequest();

  xmlhttp.open('GET', '/api/auth/logout', true);

  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState === 4) {
      authApi.getProfile()
        .then(profile => resolve(profile))
        .catch(error => reject(error));
    }
  };

  xmlhttp.send();
});

export default authApi